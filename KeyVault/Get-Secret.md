How to get a Key Vault Secret via the REST API

## Azure Design
You need the following Azure resources in place to use the Key Vault system.

1. **Azure Subscription**: Contains all your Azure assets
1. **Azure Active Directory**: Contains the Service Principal
1. **Service Principal**: Service account that is granted permission to read a Key Vault Secret
1. **Resource Group**: Contains a Key Vault
1. **Key Vault**: Contains a Secret
1. **Key Vault - Secret**: Contains a Secret Value
1. **Key Vault - Policy**: Grants 'Secret Get Permission' to Service Principal

![](https://github.com/vhiwase/azure-rest/tree/master/KeyVault/Assets/key-vault-design.png)

## REST API Authorization

The Azure Key Vault REST API authorizes users via a Bearer Token in the the Authorization header. 

```
GET /secrets/{{secretName}}/?api-version={{apiVersion}} HTTP/1.1
Host: {{vaultUri}}
Authorization: Bearer {{bearerToken}}
Content-Type: application/json
```

That Bearer Token is generated by calling the /oauth2/token endpoint with the Service Principal's Id/Secret and a Resource set to 'https://vault.azure.net'.

```
POST /{{tenantId}}/oauth2/token HTTP/1.1
Host: login.microsoftonline.com
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials&client_id={{clientId}}&client_secret={{clientSecret}}&resource=https://vault.azure.net
```

We are now going to create all the Azure Resources we need, generate the Bearer Token and call the Get Secrets REST API with it.

## Azure Resource Setup

Here are the steps you need to take to get your Azure environment prepared for Key Vault and REST API access.  

You can run the following in the [Azure Cloud Shell](https://azure.microsoft.com/en-us/features/cloud-shell/) or a local terminal.

> You can find the entire script that you can copy and paste as a whole [here](https://github.com/jonbgallant/azure-rest/blob/master/key-vault/azure-setup.sh). 

1. **Open [Azure Cloud Shell](https://azure.microsoft.com/en-us/features/cloud-shell/) or Install [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest)**
    We will use the Azure CLI to create all of our required resources.
1. **Setup Variables**

    The following variables will be in the following CLI scripts. At a minimum, you need to set your subscription Id, which you can find in the portal or via the Azure CLI.

    1. Copy the following code to Notepad
    1. Change at least the SUBSCRIPTION_ID
    1. Copy and paste and execute in your terminal
    ```
    SUBSCRIPTION_ID=f9766876-e50b-436f-9ad3-5afb7bb8cf45
    SERVICE_PRINCIPAL_NAME=azurekeyvaultsp1
    SERVICE_PRINCIPAL_PASSWORD=jongpassword
    RESOURCE_GROUP=jongdemorg1
    RESOURCE_GROUP_LOCATION=westus
    RESOURCE=https://vault.azure.net
    KEYVAULT_NAME=jongkeyvaultdemo1
    KEYVAULT_SECRET_NAME=jongsecretname
    KEYVAULT_SECRET_VALUE=jongsecretvalue
    ```
1. **Login**

    Authenticate with the Azure CLI   

    `az login`

1. **Set Active Subscription**

    If you have more than one subscription, you need to set the Active one to work with in this session.

    `az account set -s $SUBSCRIPTION_ID`

1. **Set Tenant Id**

    Set the TENANT_ID variable which is needed to get the Bearer Token later.

    `TENANT_ID=$(az account show --query tenantId -otsv)`

1. **Create Service Principal**

    You will use the Service Principal's AppId and Password to get your Oauth Bearer Token

    `az ad sp create-for-rbac -n $SERVICE_PRINCIPAL_NAME -p $SERVICE_PRINCIPAL_PASSWORD`

1. **Get Service Principal AppId**

    This sets the SERVICE_PRINCIPAL_APP_ID variable that will be used as clientId later.

    `SERVICE_PRINCIPAL_APP_ID=$(az ad sp list --display-name $SERVICE_PRINCIPAL_NAME --query [0].appId -otsv)`

1. **Create Resource Group**

    This creates the resource group that will contain the Key Vault.

    `az group create --name $RESOURCE_GROUP --location $RESOURCE_GROUP_LOCATION`

1. **Create KeyVault**

    This creates the Key Vault that will hold the Secret

    `az keyvault create -n $KEYVAULT_NAME -g $RESOURCE_GROUP`

1. **Get KeyVaule URI**

    This sets the KEYVAULT_URI that is need to build the REST API URI.

    `KEYVAULT_URI=$(az keyvault show -n $KEYVAULT_NAME --query properties.vaultUri -otsv)`

1. **Create Secret**

    This creates a secret and gives it a value.

    `az keyvault secret set --name $KEYVAULT_SECRET_NAME --vault-name $KEYVAULT_NAME --value $KEYVAULT_SECRET_VALUE`

1. **Give Service Principal Access to KeyVault**

    This gives the service principal access to the Key Vault with 'Get' secret permissions.

    `az keyvault set-policy --name $KEYVAULT_NAME --secret-permissions get --spn http://$SERVICE_PRINCIPAL_NAME`

1. **Output Variables**

    Execute the following to see a properly formatted variable list that you can use in Postman.

    ```
    printf "\n\nclientId:$SERVICE_PRINCIPAL_APP_ID\nclientSecret:$SERVICE_PRINCIPAL_PASSWORD\ntenantId:$TENANT_ID\nsubscriptionId:$SUBSCRIPTION_ID\nvaultUri:$KEYVAULT_URI\nsecretName:$KEYVAULT_SECRET_NAME\napiVersion:2016-10-01\nresource:$RESOURCE\n\n"
    ```

    You will see an output like the following:

    ```
    clientId:f39645b8-410f-4ee0-9ec4-e1c0eb37a2e1
    clientSecret:jongpassword
    tenantId:72f988bf-86f1-41af-91ab-2d7cd011db47
    subscriptionId:f9766876-e50b-436f-9ad3-5afb7bb8cf45
    vaultUri:https://jongkeyvaultdemo1.vault.azure.net/
    secretName:jongsecretname
    apiVersion:2016-10-01
    resource:https://vault.azure.net
    ```

    ![](https://github.com/vhiwase/azure-rest/tree/master/KeyVault/Assets/key-vault-postman-output.png)


    
    > Copy this to a safe place. You will need it later.

## Postman Setup
1. Install [Postman](https://getpostman.com)

1. Create a new Environment called Azure Key Vault
    1. Click 'Gear Icon -> Manage Environment'

        ![](https://github.com/vhiwase/azure-rest/tree/master/KeyVault/Assets/key-vault-create-env.png)

    1. Click 'Add', Enter Azure Key Vault for name

        ![](https://github.com/vhiwase/azure-rest/tree/master/KeyVault/Assets/key-vault-create-env-name.png)

1. Copy Variables to Environment
    1. Click 'Bulk Edit'
    1. Copy Variable output from above:

        ![](https://github.com/vhiwase/azure-rest/tree/master/KeyVault/Assets/key-vault-create-env-variables.png)

    1. Click 'Add'
1. Select Azure Key Vault Environment
    1. Click the Environment dropdown in the upper right and select Azure Key Vault

        ![](https://github.com/vhiwase/azure-rest/tree/master/KeyVault/Assets/key-vault-create-env-select.png)

1. Create a new Collection called Azure Key Vault

    ![](https://github.com/vhiwase/azure-rest/tree/master/KeyVault/Assets/key-vault-create-collection.png)

1. Add Collection Pre-Request Script to get Bearer Token

    The following code will POST to the Azure Oauth/Token endpoint to get a Bearer Token and set in Postman global variable called 'bearerToken`, which you will use in your Authorization header when you make the Get Secret request.

    1. Right click on the Collection and select Edit and then copy and paste this code:

    ```    
    pm.sendRequest({
            url: 'https://login.microsoftonline.com/' + pm.environment.get("tenantId") + '/oauth2/token',
            method: 'POST',
            header: 'Content-Type: application/x-www-form-urlencoded',
            body: {
                mode: 'urlencoded',
                urlencoded: [ 
                    {key: "grant_type", value: "client_credentials", disabled: false},
                    {key: "client_id", value: pm.environment.get("clientId"), disabled: false},
                    {key: "client_secret", value: pm.environment.get("clientSecret"), disabled: false},
                    {key: "resource", value: pm.environment.get("resource"), disabled: false}
                ]
            }
        }, function (err, res) {
            pm.globals.set("bearerToken", res.json().access_token);
            console.log(pm.globals.get("bearerToken"));
        });
    ```

    ![](https://github.com/vhiwase/azure-rest/tree/master/KeyVault/Assets/key-vault-pre-request-script.png)

1. Create a new Request called Get Secret with the following settings:

    ```
    GET /secrets/{{secretName}}/?api-version={{apiVersion}} HTTP/1.1
    Host: {{vaultUri}}
    Authorization: Bearer {{bearerToken}}
    Content-Type: application/json
    ```
    ![](https://github.com/vhiwase/azure-rest/tree/master/KeyVault/Assets/key-vault-postman-get-secret.png)

1. Save that Request to the Azure Key Vault Collection
1. Click "Send"
1. View Secret Vault in Response
    ```
    {
        "value": "jongsecretvalue",
        "id": "https://jongkeyvaultdemo7.vault.azure.net/secrets/jongsecretname/ffc777bb6e9642cc92feb0fb99490715",
        "attributes": {
            "enabled": true,
            "created": 1516199071,
            "updated": 1516199071,
            "recoveryLevel": "Purgeable"
        },
        "tags": {
            "file-encoding": "utf-8"
        }
    }
    ```
    ![](https://github.com/vhiwase/azure-rest/tree/master/KeyVault/Assets/key-vault-get-secret-response.png)

1. Use the Secret in your application by wrapping the REST calls above in your favorite language.
